const translations = {
    ko: {
        page_title: "한국 도자기 - 전통과 현대의 조화",
        logo: "한국 도자기",
        nav_home: "홈",
        nav_products: "제품",
        nav_about: "소개",
        nav_contact: "문의",
        hero_title: "아름다운 한국의 미",
        hero_subtitle: "전통과 현대가 어우러진 특별한 도자기를 만나보세요.",
        products_title: "추천 제품",
        theme_system: "시스템 기본값",
        theme_dark: "다크 모드",
        theme_light: "라이트 모드",
        footer_name: "한국 도자기",
        back_to_list: "목록으로 돌아가기",
        products: [
            {
                id: 1,
                name: "청자 상감 운학문 매병",
                price: "350,000원",
                image: "https://images.unsplash.com/photo-1578973625969-8e12d4d124d7?q=80&w=1974&auto=format&fit=crop",
                description: "청자 상감 운학문 매병은 고려 시대의 대표적인 청자로, 구름 사이를 날아가는 학의 모습을 정교한 상감 기법으로 표현한 걸작입니다. 우아한 곡선과 비색의 아름다움을 느껴보세요."
            },
            {
                id: 2,
                name: "백자 달항아리",
                price: "550,000원",
                image: "https://images.unsplash.com/photo-1615325852939-715c5a894a4a?q=80&w=2070&auto=format&fit=crop",
                description: "백자 달항아리는 보름달처럼 넉넉하고 둥근 형태가 특징인 조선 시대의 대표적 백자입니다. 아무런 장식 없이 백색의 순수함과 절제미를 강조하여 현대적인 공간에도 잘 어우러집니다."
            },
            {
                id: 3,
                name: "분청사기 박지철채화문 병",
                price: "280,000원",
                image: "https://images.unsplash.com/photo-1578973625969-8e12d4d124d7?q=80&w=1974&auto=format&fit=crop",
                description: "분청사기 박지철채화문 병은 자유분방하고 해학적인 아름다움을 지닌 도자기입니다. 표면을 깎아내고 철채를 더해 강렬한 생명력과 소박한 멋을 동시에 보여줍니다."
            }
        ]
    },
    en: {
        page_title: "Korean Pottery",
        logo: "K-Pottery",
        nav_home: "Home",
        nav_products: "Products",
        nav_about: "About",
        nav_contact: "Contact",
        hero_title: "The Beauty of Korea",
        hero_subtitle: "Discover special pottery where tradition meets modernity.",
        products_title: "Featured Collections",
        theme_system: "System Default",
        theme_dark: "Dark Mode",
        theme_light: "Light Mode",
        footer_name: "Korean Pottery Studio",
        back_to_list: "Back to List",
        products: [
            {
                id: 1,
                name: "Celadon Prunus Vase",
                price: "₩350,000",
                image: "https://images.unsplash.com/photo-1578973625969-8e12d4d124d7?q=80&w=1974&auto=format&fit=crop",
                description: "The Celadon Prunus Vase is a representative Goryeo-era masterpiece. It features delicate crane and cloud patterns created using the sanggam (inlay) technique, showcasing elegant curves and jade-green beauty."
            },
            {
                id: 2,
                name: "White Porcelain Moon Jar",
                price: "₩550,000",
                image: "https://images.unsplash.com/photo-1615325852939-715c5a894a4a?q=80&w=2070&auto=format&fit=crop",
                description: "The Moon Jar is a iconic Joseon-dynasty white porcelain known for its generous, round shape resembling a full moon. Its pure white color and understated beauty harmonize with modern spaces."
            },
            {
                id: 3,
                name: "Buncheong Decorated Jar",
                price: "₩280,000",
                image: "https://images.unsplash.com/photo-1578973625969-8e12d4d124d7?q=80&w=1974&auto=format&fit=crop",
                description: "This Buncheong jar possesses a free-spirited and humorous beauty. The combination of carved surfaces and iron painting creates a vibrant yet rustic charm unique to Korean aesthetics."
            }
        ]
    },
    ja: {
        page_title: "韓国の陶磁器",
        logo: "韓国陶磁器",
        nav_home: "ホーム",
        nav_products: "製品",
        nav_about: "紹介",
        nav_contact: "お問い合わせ",
        hero_title: "美しい韓国の美",
        hero_subtitle: "伝統と現代が調和した特別な陶磁器に出会ってください。",
        products_title: "おすすめ商品",
        theme_system: "システム設定",
        theme_dark: "ダークモード",
        theme_light: "ライトモード",
        footer_name: "韓国陶磁器工房",
        back_to_list: "一覧に戻る",
        products: [
            {
                id: 1,
                name: "青磁象嵌雲鶴文梅瓶",
                price: "350,000ウォン",
                image: "https://images.unsplash.com/photo-1578973625969-8e12d4d124d7?q=80&w=1974&auto=format&fit=crop",
                description: "高麗時代の代表的な青磁で、雲の間を飛ぶ鶴の姿を精巧な象嵌技法で表現した名作です。優雅な曲線と翡翠色の美しさを感じてください。"
            },
            {
                id: 2,
                name: "白磁月壺",
                price: "550,000ウォン",
                image: "https://images.unsplash.com/photo-1615325852939-715c5a894a4a?q=80&w=2070&auto=format&fit=crop",
                description: "満月のような豊かで丸い形が特徴の、朝鮮時代を代表する白磁です。装飾을 배제한 白色の純粋さと節制美は、現代の空間にもよく馴染みます。"
            },
            {
                id: 3,
                name: "粉青沙器剥地철채화문병",
                price: "280,000ウォン",
                image: "https://images.unsplash.com/photo-1578973625969-8e12d4d124d7?q=80&w=1974&auto=format&fit=crop",
                description: "自由奔放でユーモラスな美しさを持つ陶磁器です。表面を削り取り、鉄彩を加えることで、強い生命力と素朴な趣を同時に表現しています。"
            }
        ]
    }
};

class ProductCard extends HTMLElement {
    constructor() {
        super();
        const shadow = this.attachShadow({ mode: 'open' });
        const wrapper = document.createElement('div');
        wrapper.setAttribute('class', 'product-card');

        const style = document.createElement('style');
        style.textContent = `
            .product-card {
                background-color: var(--card-bg, white);
                color: var(--text-color, #333);
                border: 1px solid var(--card-border, transparent);
                border-radius: 12px;
                padding: 0;
                text-align: left;
                box-shadow: 0 10px 30px var(--shadow-color, rgba(0,0,0,0.05));
                transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1), box-shadow 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
                overflow: hidden;
                display: flex;
                flex-direction: column;
                height: 100%;
                cursor: pointer;
            }
            .product-card:hover {
                transform: translateY(-8px);
                box-shadow: 0 20px 40px var(--shadow-color, rgba(0,0,0,0.1));
            }
            .image-container {
                width: 100%;
                padding-top: 100%;
                position: relative;
                overflow: hidden;
                background-color: #f0f0f0;
            }
            .product-card img {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.6s ease;
            }
            .product-card:hover img { transform: scale(1.05); }
            .content { padding: 1.5rem; display: flex; flex-direction: column; flex-grow: 1; }
            h3 { font-family: var(--font-serif, serif); font-size: 1.1rem; margin: 0 0 0.5rem 0; font-weight: 600; }
            p { color: var(--accent-color, #8d6e63); font-weight: 500; margin: auto 0 0 0; font-size: 1rem; }
        `;

        shadow.appendChild(style);
        shadow.appendChild(wrapper);

        wrapper.addEventListener('click', () => {
            this.dispatchEvent(new CustomEvent('product-click', {
                detail: { id: this.getAttribute('product-id') },
                bubbles: true,
                composed: true
            }));
        });
    }

    connectedCallback() {
        this.render();
    }

    static get observedAttributes() {
        return ['name', 'price', 'image', 'product-id'];
    }

    attributeChangedCallback() {
        this.render();
    }

    render() {
        const wrapper = this.shadowRoot.querySelector('.product-card');
        if (!wrapper) return;

        wrapper.innerHTML = `
            <div class="image-container">
                <img src="${this.getAttribute('image')}" alt="${this.getAttribute('name')}">
            </div>
            <div class="content">
                <h3>${this.getAttribute('name')}</h3>
                <p>${this.getAttribute('price')}</p>
            </div>
        `;
    }
}

customElements.define('product-card', ProductCard);

// Language & Theme State
let currentLang = localStorage.getItem('lang') || 'ko';
let currentTheme = localStorage.getItem('theme') || 'system';
let selectedProductId = null;

function updateMetaTags(title, description, image, url) {
    document.title = title;

    // Update meta description
    const metaDesc = document.querySelector('meta[name="description"]');
    if (metaDesc) metaDesc.setAttribute('content', description);

    // Update OG tags
    const ogTitle = document.querySelector('meta[property="og:title"]');
    if (ogTitle) ogTitle.setAttribute('content', title);
    const ogDesc = document.querySelector('meta[property="og:description"]');
    if (ogDesc) ogDesc.setAttribute('content', description);
    const ogImage = document.querySelector('meta[property="og:image"]');
    if (ogImage && image) ogImage.setAttribute('content', image);
    const ogUrl = document.querySelector('meta[property="og:url"]');
    if (ogUrl && url) ogUrl.setAttribute('content', url);

    // Update Twitter tags
    const twTitle = document.querySelector('meta[name="twitter:title"]');
    if (twTitle) twTitle.setAttribute('content', title);
    const twDesc = document.querySelector('meta[name="twitter:description"]');
    if (twDesc) twDesc.setAttribute('content', description);
    const twImage = document.querySelector('meta[name="twitter:image"]');
    if (twImage && image) twImage.setAttribute('content', image);

    // Update Canonical
    const canonical = document.querySelector('link[rel="canonical"]');
    if (canonical && url) canonical.setAttribute('href', url);
}

function updateUI() {
    // Update static text
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[currentLang][key]) {
            el.textContent = translations[currentLang][key];
        }
    });

    const productsSection = document.querySelector('.products');
    const productDetailSection = document.getElementById('product-detail');
    const heroSection = document.querySelector('.hero');

    if (selectedProductId) {
        const product = translations[currentLang].products.find(p => p.id == selectedProductId);
        if (product) {
            productsSection.style.display = 'none';
            heroSection.style.display = 'none';
            productDetailSection.style.display = 'block';

            // Update URL hash for deep linking
            window.history.replaceState(null, '', `#product-${selectedProductId}`);

            // Update SEO Metadata
            const pageTitle = `${product.name} | ${translations[currentLang].footer_name}`;
            const currentUrl = window.location.href;
            updateMetaTags(pageTitle, product.description, product.image, currentUrl);

            productDetailSection.innerHTML = `
                <div class="detail-container">
                    <button class="back-btn" id="back-btn">${translations[currentLang].back_to_list}</button>
                    <div class="detail-grid">
                        <div class="detail-image">
                            <img src="${product.image}" alt="${product.name}">
                        </div>
                        <div class="detail-content">
                            <h2>${product.name}</h2>
                            <p class="detail-price">${product.price}</p>
                            <p class="detail-description">${product.description}</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('back-btn').addEventListener('click', () => {
                selectedProductId = null;
                updateUI();
            });
        }
    } else {
        productsSection.style.display = 'block';
        heroSection.style.display = 'flex';
        productDetailSection.style.display = 'none';

        // Remove hash from URL
        if (window.location.hash) {
            window.history.replaceState(null, '', window.location.pathname + window.location.search);
        }

        // Restore Default SEO Metadata
        const defaultTitle = translations[currentLang].page_title + (currentLang === 'ko' ? " | 청자, 백자, 분청사기" : "");
        const defaultDesc = translations[currentLang].products.map(p => p.name).join(', ') + " 등 고품격 도자기 제품을 만나보세요.";
        const defaultUrl = window.location.origin + window.location.pathname;
        const defaultImg = "https://product-builder1-7f0.pages.dev/images/og-main.jpg";
        updateMetaTags(defaultTitle, defaultDesc, defaultImg, defaultUrl);

        // Update dynamic products
        const productList = document.getElementById('product-list');
        productList.innerHTML = '';
        translations[currentLang].products.forEach(p => {
            const card = document.createElement('product-card');
            card.setAttribute('name', p.name);
            card.setAttribute('price', p.price);
            card.setAttribute('image', p.image);
            card.setAttribute('product-id', p.id);
            card.addEventListener('product-click', (e) => {
                selectedProductId = e.detail.id;
                updateUI();
                window.scrollTo(0, 0);
            });
            productList.appendChild(card);
        });
    }

    // Update active lang button
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-lang') === currentLang);
    });

    // Update theme button text
    const themeBtn = document.getElementById('theme-btn');
    themeBtn.textContent = translations[currentLang][`theme_${currentTheme}`];
}

function applyTheme(theme) {
    if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.body.setAttribute('data-theme', 'dark');
    } else {
        document.body.removeAttribute('data-theme');
    }
}

// Event Listeners
document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        currentLang = btn.getAttribute('data-lang');
        localStorage.setItem('lang', currentLang);
        updateUI();
    });
});

const themeBtn = document.getElementById('theme-btn');
themeBtn.addEventListener('click', () => {
    if (currentTheme === 'system') {
        currentTheme = 'light';
    } else if (currentTheme === 'light') {
        currentTheme = 'dark';
    } else {
        currentTheme = 'system';
    }

    localStorage.setItem('theme', currentTheme);
    applyTheme(currentTheme);
    updateUI();
});

// Update automatically if system theme changes while 'system' is selected
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    if (currentTheme === 'system') {
        applyTheme('system');
    }
});

// Initialize
applyTheme(currentTheme);

// Check URL Hash for deep linking
if (window.location.hash && window.location.hash.startsWith('#product-')) {
    const hashId = parseInt(window.location.hash.replace('#product-', ''));
    if (!isNaN(hashId)) {
        selectedProductId = hashId;
    }
}

function updateClock() {
    const hourHand = document.getElementById('hour-hand');
    const minuteHand = document.getElementById('minute-hand');
    const secondHand = document.getElementById('second-hand');

    const now = new Date();
    const seconds = now.getSeconds();
    const minutes = now.getMinutes();
    const hours = now.getHours();

    const secondDegrees = (seconds / 60) * 360;
    const minuteDegrees = ((minutes + seconds / 60) / 60) * 360;
    const hourDegrees = ((hours % 12 + minutes / 60) / 12) * 360;

    if (secondHand) secondHand.style.transform = `translateX(-50%) rotate(${secondDegrees}deg)`;
    if (minuteHand) minuteHand.style.transform = `translateX(-50%) rotate(${minuteDegrees}deg)`;
    if (hourHand) hourHand.style.transform = `translateX(-50%) rotate(${hourDegrees}deg)`;
}

setInterval(updateClock, 1000);
updateClock();
updateUI();
